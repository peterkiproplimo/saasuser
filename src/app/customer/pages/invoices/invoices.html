<div class="p-4 overflow-auto">
  <div class="flow-root">
    <div class="m-0">
      <!-- Filters -->
      <div class="mb-4 grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4 gap-4">
        <div class="w-full flex flex-col">
          <label for="">Status</label>
          <p-dropdown
            [(ngModel)]="status"
            [options]="status_options"
            placeholder="Select Status"
            class="w-full"
            [showClear]="true"
            [filter]="true"
            filterBy="label,value"
            [styleClass]="'w-full'"
          />
        </div>

        <div class="w-full">
          <label for="">Search Term</label>
          <input
            [(ngModel)]="search_text"
            placeholder="Search"
            class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
          />
        </div>

        <div class="w-full">
          <label for="">Start Date</label>
          <p-calendar
            appendTo="body"
            [(ngModel)]="start_date"
            [showIcon]="true"
            [showButtonBar]="true"
            [placeholder]="'Start Date'"
            [dateFormat]="'mm/dd/yy'"
            [maxDate]="end_date()"
            styleClass="w-full"
          />
        </div>

        <div class="w-full">
          <label for="">End Date</label>
          <p-calendar
            appendTo="body"
            [(ngModel)]="end_date"
            [showIcon]="true"
            [showButtonBar]="true"
            [placeholder]="'End Date'"
            [dateFormat]="'mm/dd/yy'"
            [minDate]="start_date()"
            styleClass="w-full"
          />
        </div>
      </div>

      <!-- Table -->
      <div class="inline-block min-w-full py-2 align-middle">
        <div
          class="overflow-hidden shadow-sm ring-1 ring-black/5 sm:rounded-lg"
        >
          <table
            class="min-w-full divide-y divide-gray-300 dark:divide-gray-700"
          >
            <thead class="bg-gray-50 dark:bg-gray-800">
              <tr>
                <th
                  scope="col"
                  class="py-3.5 pr-3 pl-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6"
                >
                  Invoice No
                </th>
                <th
                  scope="col"
                  class="py-3.5 pr-3 pl-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6"
                >
                  Posting Date
                </th>
                <th
                  scope="col"
                  class="py-3.5 pr-3 pl-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6"
                >
                  Due Date
                </th>
                <th
                  scope="col"
                  class="py-3.5 pr-3 pl-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6"
                >
                  Grand Total
                </th>
                <th
                  scope="col"
                  class="py-3.5 pr-3 pl-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6"
                >
                  Outstanding Amount
                </th>
                <th
                  scope="col"
                  class="py-3.5 pr-3 pl-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6"
                >
                  Currency
                </th>
                <th
                  scope="col"
                  class="py-3.5 pr-3 pl-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6"
                >
                  Status
                </th>
                <th
                  scope="col"
                  class="py-3.5 pr-3 pl-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6"
                >
                  Type
                </th>
                <th scope="col" class="relative py-3.5 pr-4 pl-3 sm:pr-6">
                  View Details
                </th>
                <th scope="col" class="relative py-3.5 pr-4 pl-3 sm:pr-6">
                  Pay
                </th>
              </tr>
            </thead>

            <tbody
              class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-900"
            >
              <!-- Loading State -->
              @if (is_loading()) {
              <tr class="w-full">
                <td colspan="9" class="text-center py-4">
                  <div class="w-full flex justify-center">
                    <p-progressSpinner
                      class="text-gray-500 dark:text-gray-400"
                      [style]="{ width: '40px', height: '40px' }"
                    >
                    </p-progressSpinner>
                  </div>
                </td>
              </tr>
              } @else { @if (invoices().data?.length! > 0) { @for (invoice of
              invoices().data; track invoice.name) {
              <tr class="w-full">
                <td
                  class="py-3 px-4 text-sm font-medium whitespace-nowrap text-gray-900 dark:text-gray-100"
                >
                  {{ invoice.name }}
                </td>
                <td class="py-3 px-4 text-sm whitespace-nowrap">
                  {{ invoice.posting_date | date:'dd-MMM-yyyy' }}
                </td>
                <td class="py-3 px-4 text-sm whitespace-nowrap">
                  {{ invoice.due_date | date:'dd-MMM-yyyy' }}
                </td>
                <td class="py-3 px-4 text-sm whitespace-nowrap">
                  {{ invoice.grand_total | number:'1.2-2' }}
                </td>
                <td class="py-3 px-4 text-sm whitespace-nowrap">
                  {{ invoice.outstanding_amount | number:'1.2-2' }}
                </td>
                <td class="py-3 px-4 text-sm whitespace-nowrap">
                  {{ invoice.currency }}
                </td>
                <td
                  class="py-3 px-4 text-sm whitespace-nowrap"
                  [ngClass]="{
                            'text-blue-600 dark:text-blue-400': invoice.status == 'Paid',
                            'text-yellow-600 dark:text-yellow-400': invoice.status == 'Unpaid',
                          }"
                >
                  {{ invoice.status }}
                </td>
                <td class="py-3 px-4 text-sm whitespace-nowrap">
                  {{ invoice.type }}
                </td>

                <td class="px-3 py-2 text-center">
                  <button
                    (click)="handle_invoice_download(invoice.name!)"
                    [disabled]="isRowLoading(invoice.name!)"
                    class="px-3 py-1 text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-md transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    @if (isRowLoading(invoice.name!)) {
                      <i class="pi pi-spin pi-spinner mr-1"></i>
                    } @else {
                      <i class="pi pi-eye mr-1"></i>
                    }
                    View Invoice
                  </button>
                </td>

                <td class="px-3 py-2 text-center">
                  @if (invoice.status != 'Paid') {
                  <button
                    (click)="open_invoice_dialog(invoice)"
                    class="px-3 py-1 text-sm font-medium text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-md transition-colors"
                  >
                    <i class="pi pi-credit-card mr-1"></i>
                    Pay
                  </button>
                  } @else {
                  <div class="flex items-center justify-center">
                    <i class="pi pi-check-circle text-green-600 dark:text-green-400 text-lg"></i>
                    <span class="ml-1 text-sm font-medium text-green-600 dark:text-green-400">Paid</span>
                  </div>
                  }
                </td>
              </tr>
              } } @else {
              <tr class="w-full">
                <td colspan="9" class="py-4">
                  <div class="w-full flex justify-center">
                    <app-empty-state class="text-center">
                      <h3
                        class="text-lg font-medium text-gray-700 dark:text-gray-300"
                        slot="title"
                      >
                        No Invoices Found
                      </h3>
                      <p
                        class="text-gray-500 dark:text-gray-400 mt-2"
                        slot="message"
                      >
                        Try adjusting your search term or check back later for
                        more Invoices.
                      </p>
                    </app-empty-state>
                  </div>
                </td>
              </tr>
              } }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Paginator -->
<div class="flex justify-center w-full">
  <p-paginator
    (onPageChange)="onPageChange($event)"
    [first]="first()"
    [rows]="pageSize()"
    [totalRecords]="totalRecords()"
    [showCurrentPageReport]="true"
    [showPageLinks]="false"
    [showJumpToPageDropdown]="false"
    [rowsPerPageOptions]="[5, 10, 20, 30]"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords}"
  />
</div>

<!-- Payment Form Dialog -->
<p-dialog
  [(visible)]="payment_dialog"
  [style]="{ width: '450px' }"
  header="Make Payment"
  [modal]="true"
>
  <form
    class="w-full space-y-6"
    (ngSubmit)="pay_invoice()"
    [formGroup]="payment_form"
  >
    <app-reactive-input
      [form]="payment_form"
      [id]="'email'"
      [key]="'email'"
      [label]="'Email Address'"
      [type]="'email'"
    >
    </app-reactive-input>

    <app-reactive-input
      [form]="payment_form"
      [id]="'amount'"
      [key]="'amount'"
      [label]="'Amount'"
      [minval]="1"
      [type]="'number'"
    >
    </app-reactive-input>

    <app-reactive-input
      [form]="payment_form"
      [id]="'phone'"
      [key]="'phone'"
      [label]="'Phone Number'"
      [type]="'text'"
    >
    </app-reactive-input>

    <div class="flex w-full justify-end gap-2 mt-3">
      <button
        type="button"
        (click)="hideDialog()"
        class="flex justify-center items-center gap-2 rounded-md bg-gray-800 dark:bg-gray-700 px-3 py-1.5 text-sm/6 font-semibold text-white shadow-xs hover:bg-gray-700 dark:hover:bg-gray-600"
      >
        Cancel
      </button>
      <button
        [disabled]="payment_loading()"
        class="flex justify-center items-center gap-2 rounded-md bg-blue-600 dark:bg-blue-700 px-3 py-1.5 text-sm/6 font-semibold text-white shadow-xs hover:bg-blue-500 dark:hover:bg-blue-600"
      >
        Make Payment @if (payment_loading()) {
        <p-progress-spinner
          strokeWidth="8"
          fill="transparent"
          animationDuration=".5s"
          [style]="{ width: '20px', height: '20px' }"
        />
        } @else { }
      </button>
    </div>
  </form>
</p-dialog>

<!-- Payment Iframe Dialog -->
<p-dialog
  [(visible)]="iframe_dialog"
  [style]="{ width: '800px', height: '700px' }"
  header="Complete Payment"
  [modal]="true"
>
  @if (payment_iframe_url()) {
  <iframe
    [src]="payment_iframe_url()"
    width="100%"
    height="650px"
    frameborder="0"
    sandbox="allow-scripts allow-same-origin allow-forms"
  ></iframe>
  }
</p-dialog>

<p-dialog
  [(visible)]="error_dialog"
  [style]="{ width: '450px' }"
  header="Payment Error"
  [modal]="true"
  (onHide)="error_message.set('')"
>
  <div class="p-4">
    <p class="text-red-600 dark:text-red-400">{{ error_message() }}</p>
    <div class="flex justify-end mt-4">
      <button
        type="button"
        (click)="error_dialog.set(false)"
        class="flex justify-center items-center gap-2 rounded-md bg-gray-800 dark:bg-gray-700 px-3 py-1.5 text-sm/6 font-semibold text-white shadow-xs hover:bg-gray-700 dark:hover:bg-gray-600"
      >
        Close
      </button>
    </div>
  </div>
</p-dialog>

<!-- Invoice Preview Dialog -->
<p-dialog
  [(visible)]="invoice_preview_dialog"
  [style]="{ width: '95vw', height: '90vh', maxWidth: '1400px' }"
  header="Invoice Preview"
  [modal]="true"
  [closable]="true"
  (onHide)="close_invoice_preview()"
  [styleClass]="'invoice-preview-dialog'"
>
  @if (selected_invoice_for_preview()) {
    <div class="flex h-full gap-4">
      <div class="flex-1 overflow-y-auto p-4">
        <div class="flex justify-end gap-3 mb-4">
          <button
            type="button"
            (click)="print_invoice()"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center gap-2"
          >
            <i class="pi pi-print"></i>
            Print
          </button>
          <button
            type="button"
            (click)="download_invoice_from_preview()"
            class="px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center gap-2"
          >
            <i class="pi pi-download"></i>
            Download
          </button>
        </div>
        
        <div id="pdf-content" class="bg-white rounded-xl shadow-2xl min-h-full">
          <div class="p-6">
            <!-- Billing From/To with Billing To shifted to far right -->
            <div class="flex justify-between items-start mb-6">
              <div class="w-1/2">
                <div class="text-sm font-bold text-blue-600 mb-2 uppercase tracking-wide">Billing From</div>
                <div class="text-xs text-gray-700">
                  <strong>Techsavanna Company Limited</strong><br>
                  Reliance Centre - 2nd Floor, Left Wing<br>
                  Westlands Woodvale Grove<br>
                  Nairobi, Kenya<br>
                  Phone: 0719535899<br>
                  Email: admin&#64;techsavanna.technology
                </div>
              </div>
              <div class="w-1/2 text-right">
                <div class="text-sm font-bold text-blue-600 mb-2 uppercase tracking-wide">Billing To</div>
                <div class="text-xs text-gray-700">
                  <strong>{{ (selected_invoice_for_preview()!.customer_name || 'Not available') }}</strong><br>
                  Email: {{ (selected_invoice_for_preview()!.customer_email || 'Not available') }}<br>
                  Phone: {{ (selected_invoice_for_preview()!.customer_phone || 'Not available') }}
                </div>
              </div>
            </div>

            <!-- Invoice Details -->
            <div class="space-y-2 mb-6">
              <div class="flex justify-between py-1 border-b border-gray-200">
                <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Invoice Number</span>
                <span class="text-xs font-medium text-gray-900">{{ selected_invoice_for_preview()!.name }}</span>
              </div>
              <div class="flex justify-between py-1 border-b border-gray-200">
                <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Posting Date</span>
                <span class="text-xs font-medium text-gray-900">{{ selected_invoice_for_preview()!.posting_date | date:'dd-MMM-yyyy' }}</span>
              </div>
              <div class="flex justify-between py-1 border-b border-gray-200">
                <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Due Date</span>
                <span class="text-xs font-medium text-gray-900">{{ selected_invoice_for_preview()!.due_date | date:'dd-MMM-yyyy' }}</span>
              </div>
              <div class="flex justify-between py-1">
                <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Status</span>
                <span class="px-2 py-1 rounded-full text-xs font-semibold uppercase
                  {{ selected_invoice_for_preview()!.status === 'Paid' ? 'bg-green-100 text-green-700' : 
                     selected_invoice_for_preview()!.status === 'Unpaid' ? 'bg-red-100 text-red-700' : 
                     'bg-yellow-100 text-yellow-700' }}">
                  {{ selected_invoice_for_preview()!.status }}
                </span>
              </div>
            </div>

            <!-- Blue separator -->
            <div class="h-0.5 bg-blue-500 my-4"></div>

            <!-- Items Table -->
            <table class="w-full border-collapse mb-6 bg-white border border-gray-300">
              <thead class="bg-blue-600 text-white">
                <tr>
                  <th class="px-3 py-2 text-left font-semibold text-xs uppercase tracking-wide">Service</th>
                  <th class="px-3 py-2 text-right font-semibold text-xs uppercase tracking-wide">Amount ({{ selected_invoice_for_preview()!.currency }})</th>
                </tr>
              </thead>
              <tbody>
                <tr class="border-b border-gray-200 even:bg-gray-50">
                  <td class="px-3 py-2 text-gray-900 text-xs">Service</td>
                  <td class="px-3 py-2 text-right font-semibold text-gray-900 text-xs">{{ selected_invoice_for_preview()!.grand_total | number:'1.2-2' }}</td>
                </tr>
              </tbody>
            </table>

            <!-- Totals -->
            <div class="space-y-1 mb-6">
              <div class="flex justify-between py-1">
                <span class="text-xs font-semibold text-gray-600">Subtotal:</span>
                <span class="text-xs font-semibold text-gray-900">{{ selected_invoice_for_preview()!.grand_total | number:'1.2-2' }} {{ selected_invoice_for_preview()!.currency }}</span>
              </div>
              <div class="flex justify-between py-1 border-t border-gray-300 pt-2">
                <span class="text-sm font-bold text-gray-900">Total Amount:</span>
                <span class="text-sm font-bold text-blue-600">{{ selected_invoice_for_preview()!.grand_total | number:'1.2-2' }} {{ selected_invoice_for_preview()!.currency }}</span>
              </div>
              <div class="flex justify-between py-1">
                <span class="text-xs font-semibold text-gray-600">Outstanding Amount:</span>
                <span class="text-xs font-bold text-red-600">{{ selected_invoice_for_preview()!.outstanding_amount | number:'1.2-2' }} {{ selected_invoice_for_preview()!.currency }}</span>
              </div>
            </div>

            <!-- Payment Instructions -->
            <div class="mt-4 p-3 bg-gray-50 border-l-4 border-blue-500 rounded">
              <div class="text-xs font-semibold text-gray-900 mb-1">Payment Instructions</div>
              <div class="text-xs text-gray-600">
                Transfer the amount to the business account below. <br>
                <strong>MPESA:</strong> Business no. 220222 | Account No. 47796595
              </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-800 text-white p-4 text-center mt-6">
              <div class="text-sm font-bold text-blue-400 mb-2">Savanna ERP Billing Platform</div>
              <div class="my-2">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center mx-auto mb-1">
                  <span class="text-white font-bold text-sm">TS</span>
                </div>
              </div>
              <div class="text-xs text-gray-300 mb-1">Your trusted partner in enterprise resource planning and billing solutions</div>
              <div class="text-xs text-gray-400">Support: support&#64;Techsavanna.com | Website: www.Techsavanna.com</div>
              <div class="text-xs text-gray-500 mt-1">Report generated on {{ getCurrentDate() }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-gray-200">
      <button
        type="button"
        (click)="close_invoice_preview()"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        Close
      </button>
    </div>
  }
</p-dialog>
