<!-- Support Tickets Page -->
<div class="min-h-screen bg-white p-6">
  <!-- Header Section -->
  <div class="mb-8">
    <div class="flex items-center gap-4 mb-6">
      <!-- Support Icon -->
      <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
        <i class="pi pi-question-circle text-white text-xl"></i>
      </div>
      <div>
        <h1 class="text-3xl font-bold text-gray-900">
          Support Tickets
        </h1>
        <p class="text-gray-600 mt-1">
          Get help and support for your TechSavanna services
        </p>
      </div>
    </div>

    <!-- New Ticket Button -->
    <div class="mb-8">
      <button
        (click)="open_dialog()"
        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium transition-colors shadow-sm border-0"
      >
        <i class="pi pi-plus text-sm"></i>
        New Ticket
      </button>
    </div>
  </div>

  <!-- Search & Filter Card -->
  <div class="bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
    <div class="flex items-center gap-2 mb-4">
      <i class="pi pi-filter text-blue-600"></i>
      <h3 class="text-lg font-semibold text-gray-900">Search & Filter</h3>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Search Input -->
      <div class="md:col-span-1">
        <label class="block text-sm font-medium text-gray-700 mb-2">Search Tickets</label>
        <div class="relative">
          <i class="pi pi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          <input
            [(ngModel)]="search_text"
            placeholder="Search by subject or description..."
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900 placeholder-gray-500"
          />
        </div>
      </div>

      <!-- Start Date -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
        <p-calendar
          appendTo="body"
          [(ngModel)]="start_date"
          [showIcon]="true"
          [showButtonBar]="true"
          [placeholder]="'Select start date'"
          [dateFormat]="'mm/dd/yy'"
          [maxDate]="end_date()"
          styleClass="w-full"
        />
      </div>

      <!-- End Date -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
        <p-calendar
          appendTo="body"
          [(ngModel)]="end_date"
          [showIcon]="true"
          [showButtonBar]="true"
          [placeholder]="'Select end date'"
          [dateFormat]="'mm/dd/yy'"
          [minDate]="start_date()"
          styleClass="w-full"
        />
      </div>
    </div>
  </div>


  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Ticket Number
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Subject
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Created At
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Type
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Status
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Loading State -->
          @if (is_loading()) {
          <tr>
            <td colspan="5" class="px-6 py-4 text-center">
              <div class="flex justify-center">
                <p-progressSpinner
                  class="text-gray-400"
                  [style]="{ width: '40px', height: '40px' }"
                />
              </div>
            </td>
          </tr>
          } @else { 
            @if (tickets().data?.length! > 0) { 
              @for (ticket of tickets().data; track ticket.name) {
              <tr 
                [routerLink]="['/customer/tickets', ticket.name]"
                class="hover:bg-gray-50 cursor-pointer transition-colors"
              >
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  {{ ticket.name }}
                </td>
                <td class="px-6 py-4 text-sm text-gray-700">
                  {{ ticket.subject }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {{ ticket.creation | date: 'MMM d, yyyy, h:mm:ss a' }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {{ ticket.ticket_type }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  @if (ticket.status === 'Open') {
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      {{ ticket.status }}
                    </span>
                  } @else if (ticket.status === 'In Progress') {
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                      {{ ticket.status }}
                    </span>
                  } @else {
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                      {{ ticket.status }}
                    </span>
                  }
                </td>
              </tr>
              } 
            } @else {
              <tr>
                <td colspan="5" class="px-6 py-12 text-center">
                  <app-empty-state class="text-center">
                    <h3 class="text-lg font-medium text-gray-700" slot="title">
                      No Tickets Found
                    </h3>
                    <p class="text-gray-500 mt-2" slot="message">
                      Try adjusting your search term or create a new ticket to get started.
                    </p>
                  </app-empty-state>
                </td>
              </tr>
            } 
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <div class="flex justify-center mt-6">
    <div class="bg-gray-100 rounded-lg px-4 py-2">
      <p-paginator
        (onPageChange)="onPageChange($event)"
        [first]="first()"
        [rows]="pageSize()"
        [totalRecords]="totalRecords()"
        [showCurrentPageReport]="true"
        dropdownAppendTo="body"
        [showPageLinks]="false"
        [showJumpToPageDropdown]="false"
        [rowsPerPageOptions]="[5, 10, 20, 30]"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords}"
        styleClass="border-0"
      />
    </div>
  </div>
</div>

<!-- New Ticket Dialog -->
<p-dialog
  [(visible)]="ticket_dialog"
  [style]="{ width: '500px' }"
  header="Create New Ticket"
  [modal]="true"
  [closable]="true"
  [styleClass]="'ticket-dialog dark-dialog'"
>
  <form
    class="w-full space-y-6"
    enctype="multipart/form-data"
    (ngSubmit)="save_ticket()"
  >
    <div class="space-y-4">
      <app-reactive-select
        [form]="ticket_form"
        [id]="'ticket_type'"
        [key]="'ticket_type'"
        [label]="'Ticket Type'"
        [choices]="ticket_types().ticket_types!"
      >
      </app-reactive-select>

      <app-reactive-select
        [form]="ticket_form"
        [id]="'priority'"
        [key]="'priority'"
        [label]="'Priority'"
        [choices]="priorities"
      >
      </app-reactive-select>

      <app-reactive-input
        [form]="ticket_form"
        [id]="'subject'"
        [key]="'subject'"
        [label]="'Subject'"
        [type]="'text'"
        [placeholder]="'Brief description of your issue'"
      >
      </app-reactive-input>

      <app-reactive-text-area
        [form]="ticket_form"
        [id]="'description'"
        [key]="'description'"
        [label]="'Description'"
        [placeholder]="'Please provide detailed information about your issue'"
      >
      </app-reactive-text-area>
    </div>

    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700">
        Attachments (Optional)
      </label>
      <p-fileUpload
        name="files"
        multiple
        customUpload="true"
        accept=".png,.jpg,.jpeg,.pdf,.doc,.docx"
        (uploadHandler)="onFileUpload($event)"
        [showUploadButton]="false"
        [auto]="true"
        [chooseLabel]="'Choose Files'"
        [cancelLabel]="'Clear'"
        [styleClass]="'w-full'"
      >
      </p-fileUpload>
      <p class="text-xs text-gray-500">
        Supported formats: PNG, JPG, PDF, DOC, DOCX (Max 10MB per file)
      </p>
    </div>

    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
      <button
        type="button"
        (click)="hideDialog()"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
      >
        Cancel
      </button>
      <button
        type="submit"
        [disabled]="loading() || ticket_form.invalid"
        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors flex items-center gap-2"
      >
        @if (loading()) {
          <p-progress-spinner
            strokeWidth="8"
            fill="transparent"
            animationDuration=".5s"
            [style]="{ width: '16px', height: '16px' }"
          />
        }
        Create Ticket
      </button>
    </div>
  </form>
</p-dialog>
